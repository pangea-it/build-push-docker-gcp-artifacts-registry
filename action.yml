name: 'Build, update and push to GHCR as well as GCPs Container Registry'
description: 'Generic action to install node dependencies, build, test, update version and push docker image to GCPs Container Registry using Workload Identity Federation for authentication'

inputs:
  token:
    description: 'GitHub access token'
    required: true
    default: ${{ github.token }}
  checkout_branch:
    description: 'Branch to checkout'
    required: false
  gcp_workload_identity_provider:
    description: 'Workload Identity Provider identifier'
    required: true
  gcp_service_account:
    description: 'GCP service account email'
    required: true 
  gcp_project_id:
    description: 'GCP project ID'
    required: true
  gcp_artifacts_repo_name:
    description: 'GCP artifcats repo. name'
    required: true
  gcp_artifacts_repo_location:
    description: 'GCP Artifacts Repo. location'
    required: true
    default: 'me-west1'
  snyk_token:
    description: 'Snyk token'
    required: false
  use_snyk:
    description: 'Using Snyk or not'
    type: string
    required: true
    default: true
  perform_tests:
    description: 'Perform unit tests or not'
    type: string
    required: true
    default: true
  npm_registry:
    description: 'NPM registry URL'
    required: true
    default: https://npm.pkg.github.com/
  npm_registry_scope:
    description: 'NPM registry scope'
    required: true
  docker_login_registry:
    description: 'Docker login registry'
    required: true
    default: gcr.io
  docker_login_user:
    description: 'Docker login username'
    required: true
    default: 'oauth2accesstoken'
  ghcr_tag_owner:
    description: 'ghcr.io org. name (owner)'
    required: true
    default: ${{ github.repository_owner }}    
  docker_image_name:
    description: 'Docker image name'
    required: true
    default: ${{ github.event.repository.name }}    

outputs:
  tagversion:
    description: "updated version updated in package.json"
    value: ${{ steps.package-version.outputs.current-version }}
  imagename:
    description: "repository name"
    value: ${{ github.event.repository.name }}
   
permissions:
  contents: 'read'
  id-token: 'write'
  packages: 'write'
  
runs:
  using: "composite"  
  
  steps:
    - name: ğŸ¤ checkout
      uses: actions/checkout@v3
      with:
        token: ${{ inputs.token }}
        ref: ${{ inputs.checkout_branch }}
  
    - name: ğŸ¶ Snyk vulnerabilies check
      uses: snyk/actions/node@master
      if: ${{ inputs.use_snyk == 'true' }}
      env:
        SNYK_TOKEN: ${{ inputs.snyk_token }}
         
    - name: â¬‡ï¸ node setup  
      uses: actions/setup-node@v3
      with:
        node-version: 16
        registry-url: ${{ inputs.npm_registry }}
        scope: ${{ inputs.npm_registry_scope }}
        token: ${{ inputs.token }}
       
    - name: ğŸ“¦ install dependencies
      run: |
        npm install
      shell: bash
      env:
        NODE_AUTH_TOKEN: ${{ inputs.token }}

    # This step attempts to add package-lock.json, in case it got changed
    # due to the installed dependencies. If nothing changed, it won't commit it.
    # Otherwise version bump push might end up with "working tree not clean" error.
    - name: ğŸ”„ update version and push to GitHub
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add package-lock.json
        git diff-index --cached --quiet HEAD || git commit -m 'updating package-lock [skip ci]' 
        npm version patch -m "GH Actions: Version updated to %s [skip ci]"
        git push
      shell: bash
    
    - name: âœï¸ get-npm-version
      id: package-version
      uses: martinbeentjes/npm-get-version-action@master
    
    - name: ğŸ”¨ build application
      run: npm run build
      shell: bash
      
    - name: ğŸ” run tests
      if: ${{ inputs.perform_tests == 'true' }}
      run: npm run test
      shell: bash
      
    - name: ğŸš® remove dev dependencies
      run: npm prune --production
      shell: bash
      
    - name: ğŸ³ set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2.2.1

    - name: 'ğŸ›« Authenticate to Google Cloud'
      id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        token_format: 'access_token'
        workload_identity_provider: ${{ inputs.gcp_workload_identity_provider }}
        service_account: ${{ inputs.gcp_service_account }}

    - name: ğŸ”‘ login to GCP Artifacts Registry
      uses: docker/login-action@v2.1.0
      with:
        registry: ${{ inputs.docker_login_registry }}
        username: ${{ inputs.docker_login_user }}
        password: ${{ steps.auth.outputs.access_token }}

#    - name: ğŸ”‘ login to GitHub Container Registry
#      uses: docker/login-action@v2.1.0
#      with:
#        registry: ghcr.io
#        username: ${{ github.actor }}
#        password: ${{ inputs.token }}
        
    - name: â›´ build and push docker image
      uses: docker/build-push-action@v3.2.0
      with:
        build-args: BRNACH_NAME=${{ github.ref_name }}
        context: .
        push: true
        tags: |
           ${{ inputs.gcp_artifacts_repo_location }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.gcp_artifacts_repo_name }}/${{ inputs.docker_image_name }}:${{ steps.package-version.outputs.current-version }}
           ${{ inputs.gcp_artifacts_repo_location }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.gcp_artifacts_repo_name }}/${{ inputs.docker_image_name }}:latest
#           ghcr.io/${{inputs.ghcr_tag_owner}}/${{inputs.docker_image_name}}:${{steps.package-version.outputs.current-version}}
#           ghcr.io/${{inputs.ghcr_tag_owner}}/${{inputs.docker_image_name}}:latest
        
    - name: ğŸš® delete old images
      uses: snok/container-retention-policy@v1.5.1
      with:
        image-names: ${{inputs.docker_image_name}}
        cut-off: 1 week ago IDT
        account-type: org
        org-name: ${{inputs.ghcr_tag_owner}}
        keep-at-least: 10
        token: ${{ inputs.token }}
